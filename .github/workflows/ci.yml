# CI/CD íŒŒì´í”„ë¼ì¸ ì›Œí¬í”Œë¡œìš°
# Pull Request ìƒì„± ì‹œ ìë™ìœ¼ë¡œ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ë° í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
name: CI

# íŠ¸ë¦¬ê±° ì¡°ê±´: main ë¸Œëœì¹˜ë¡œì˜ PR ìƒì„±/ì—…ë°ì´íŠ¸ ì‹œ ì‹¤í–‰
on:
  pull_request:
    branches: [main]

# ì›Œí¬í”Œë¡œìš°ì— í•„ìš”í•œ ìµœì†Œ ê¶Œí•œ ì„¤ì • (ë³´ì•ˆ ê°•í™”)
permissions:
  contents: read        # ë ˆí¬ì§€í† ë¦¬ ì½”ë“œ ì½ê¸° ê¶Œí•œ

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ë° ë¹Œë“œ ì‘ì—…
  # ESLint, Prettier, TypeScript ê²€ì‚¬ì™€ ë¹Œë“œë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰
  lint-build:
    runs-on: ubuntu-latest

    steps:
      # ì €ì¥ì†Œ ì½”ë“œë¥¼ ì›Œí¬í”Œë¡œìš° í™˜ê²½ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
      - name: ğŸ› Checkout repository
        uses: actions/checkout@v4

      # Bun ëŸ°íƒ€ì„ ì„¤ì • (Node.js ëŒ€ì‹  Bun ì‚¬ìš©ìœ¼ë¡œ ì„±ëŠ¥ í–¥ìƒ)
      - name: ğŸ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # Bun ì˜ì¡´ì„± ìºì‹±ìœ¼ë¡œ ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•
      # bun.lockb íŒŒì¼ í•´ì‹œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìºì‹œ í‚¤ ìƒì„±
      - name: ğŸ’¾ Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      # í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ğŸ“¥ Install dependencies
        run: bun install

      # ESLintë¡œ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (ë¬¸ë²• ì˜¤ë¥˜, ìŠ¤íƒ€ì¼ ê°€ì´ë“œ ì¤€ìˆ˜)
      - name: ğŸ§¼ ESLint check
        run: bun run lint:check

      # Prettierë¡œ ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ (ì¼ê´€ëœ ì½”ë“œ ìŠ¤íƒ€ì¼)
      - name: ğŸ’… Prettier check
        run: bun run format:check

      # TypeScript íƒ€ì… ê²€ì‚¬ (íƒ€ì… ì•ˆì „ì„± í™•ë³´)
      - name: ğŸ§  Type check
        run: bun run types:check

      # Next.js ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ (ë°°í¬ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸)
      - name: ğŸ— Build app
        run: bun run build

  # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‘ì—…
  # lint-build ì„±ê³µ í›„ ì‹¤í–‰ë˜ë©° í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ìƒì„±
  unit-test:
    runs-on: ubuntu-latest
    needs: lint-build    # lint-build ì‘ì—… ì™„ë£Œ í›„ ì‹¤í–‰

    steps:
      # ì €ì¥ì†Œ ì½”ë“œë¥¼ ì›Œí¬í”Œë¡œìš° í™˜ê²½ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
      - name: ğŸ› Checkout repository
        uses: actions/checkout@v4

      # Bun ëŸ°íƒ€ì„ ì„¤ì •
      - name: ğŸ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # ì˜ì¡´ì„± ìºì‹œ ë³µì› (ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•)
      - name: ğŸ’¾ Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      # í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ğŸ“¥ Install dependencies
        run: bun install

      # Vitestë¥¼ ì‚¬ìš©í•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ì»¤ë²„ë¦¬ì§€ ìƒì„±
      - name: ğŸ§ª Run unit tests with coverage
        run: bun run test:unit:run --coverage

      # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ë¥¼ Codecovì— ì—…ë¡œë“œ
      - name: ğŸ“Š Upload unit test coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/lcov.info    # ì»¤ë²„ë¦¬ì§€ íŒŒì¼ ê²½ë¡œ
          flags: unit-tests             # Codecovì—ì„œ êµ¬ë¶„í•˜ê¸° ìœ„í•œ í”Œë˜ê·¸
          name: unit-test-coverage      # ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì´ë¦„
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false       # ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œì—ë„ CI ì¤‘ë‹¨í•˜ì§€ ì•ŠìŒ

      # ì»¤ë²„ë¦¬ì§€ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ë‹¤ë¥¸ ì‘ì—…ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
      - name: ğŸ“¦ Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-coverage
          path: coverage/

  # Storybook ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‘ì—…
  # UI ì»´í¬ë„ŒíŠ¸ì˜ ì‹œê°ì  íšŒê·€ í…ŒìŠ¤íŠ¸ ë° ìƒí˜¸ì‘ìš© í…ŒìŠ¤íŠ¸
  storybook-test:
    runs-on: ubuntu-latest
    needs: lint-build    # lint-build ì‘ì—… ì™„ë£Œ í›„ ì‹¤í–‰

    steps:
      # ì €ì¥ì†Œ ì½”ë“œë¥¼ ì›Œí¬í”Œë¡œìš° í™˜ê²½ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
      - name: ğŸ› Checkout repository
        uses: actions/checkout@v4

      # Bun ëŸ°íƒ€ì„ ì„¤ì •
      - name: ğŸ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # ì˜ì¡´ì„± ìºì‹œ ë³µì› (ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•)
      - name: ğŸ’¾ Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      # í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ğŸ“¥ Install dependencies
        run: bun install

      # Playwright ë¸Œë¼ìš°ì € ì„¤ì¹˜ (Storybook í…ŒìŠ¤íŠ¸ìš©)
      - name: ğŸ“¥ Install Playwright Browsers
        run: bunx playwright install --with-deps

      # Storybook í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ì»¤ë²„ë¦¬ì§€ ìƒì„±
      - name: ğŸ§ª Run Storybook tests with coverage
        run: bun run test:storybook:run --coverage

      # Storybook í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ë¥¼ Codecovì— ì—…ë¡œë“œ
      - name: ğŸ“Š Upload Storybook coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/lcov.info    # ì»¤ë²„ë¦¬ì§€ íŒŒì¼ ê²½ë¡œ
          flags: storybook-tests        # Codecovì—ì„œ êµ¬ë¶„í•˜ê¸° ìœ„í•œ í”Œë˜ê·¸
          name: storybook-test-coverage # ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì´ë¦„
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false       # ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œì—ë„ CI ì¤‘ë‹¨í•˜ì§€ ì•ŠìŒ

      # Storybook ì»¤ë²„ë¦¬ì§€ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ë‹¤ë¥¸ ì‘ì—…ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
      - name: ğŸ“¦ Upload Storybook coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: storybook-test-coverage
          path: coverage/

  # í†µí•© ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ ì‘ì—…
  # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì™€ Storybook í…ŒìŠ¤íŠ¸ì˜ ì»¤ë²„ë¦¬ì§€ë¥¼ í†µí•©í•˜ì—¬ Codecovì— ì—…ë¡œë“œ
  upload-coverage:
    runs-on: ubuntu-latest
    needs: [unit-test, storybook-test]
    # í•˜ë‚˜ ì´ìƒì˜ í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰ (always()ë¡œ ì‹¤íŒ¨í•œ ì‘ì—…ë„ ê³ ë ¤)
    if: always() && (needs.unit-test.result == 'success' || needs.storybook-test.result == 'success')

    steps:
      # ì €ì¥ì†Œ ì½”ë“œë¥¼ ì›Œí¬í”Œë¡œìš° í™˜ê²½ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
      - name: ğŸ› Checkout repository
        uses: actions/checkout@v4

      # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
      - name: ğŸ“¥ Download unit test coverage
        uses: actions/download-artifact@v4
        with:
          name: unit-test-coverage
          path: ./coverage/unit/
        continue-on-error: true

      # Storybook í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
      - name: ğŸ“¥ Download Storybook coverage
        uses: actions/download-artifact@v4
        with:
          name: storybook-test-coverage
          path: ./coverage/storybook/
        continue-on-error: true

      # í†µí•©ëœ ì»¤ë²„ë¦¬ì§€ë¥¼ Codecovì— ì—…ë¡œë“œ
      - name: ğŸ“Š Upload combined coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          directory: ./coverage/        # ì»¤ë²„ë¦¬ì§€ íŒŒì¼ë“¤ì´ ìˆëŠ” ë””ë ‰í† ë¦¬
          flags: combined              # Codecovì—ì„œ êµ¬ë¶„í•˜ê¸° ìœ„í•œ í”Œë˜ê·¸
          name: combined-coverage      # í†µí•© ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì´ë¦„
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false      # ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œì—ë„ CI ì¤‘ë‹¨í•˜ì§€ ì•ŠìŒ
