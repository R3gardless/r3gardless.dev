# CI/CD íŒŒì´í”„ë¼ì¸ ì›Œí¬í”Œë¡œìš°
# Pull Request ìƒì„± ì‹œ ìë™ìœ¼ë¡œ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ë° í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
name: CI

# íŠ¸ë¦¬ê±° ì¡°ê±´: main ë¸Œëœì¹˜ë¡œì˜ PR ìƒì„±/ì—…ë°ì´íŠ¸ ì‹œ ì‹¤í–‰
on:
  pull_request:
    branches: [main]

# ì›Œí¬í”Œë¡œìš°ì— í•„ìš”í•œ ìµœì†Œ ê¶Œí•œ ì„¤ì • (ë³´ì•ˆ ê°•í™”)
permissions:
  contents: read        # ë ˆí¬ì§€í† ë¦¬ ì½”ë“œ ì½ê¸° ê¶Œí•œ

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ë° ë¹Œë“œ ì‘ì—…
  # ESLint, Prettier, TypeScript ê²€ì‚¬ì™€ ë¹Œë“œë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰
  lint-build:
    runs-on: ubuntu-latest

    steps:
      # ì €ì¥ì†Œ ì½”ë“œë¥¼ ì›Œí¬í”Œë¡œìš° í™˜ê²½ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
      - name: ğŸ› Checkout repository
        uses: actions/checkout@v6

      # Bun ëŸ°íƒ€ì„ ì„¤ì • (Node.js ëŒ€ì‹  Bun ì‚¬ìš©ìœ¼ë¡œ ì„±ëŠ¥ í–¥ìƒ)
      - name: ğŸ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # Bun ì˜ì¡´ì„± ìºì‹±ìœ¼ë¡œ ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•
      # bun.lockb íŒŒì¼ í•´ì‹œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìºì‹œ í‚¤ ìƒì„±
      - name: ğŸ’¾ Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      # í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ğŸ“¥ Install dependencies
        run: bun install

      # ESLintë¡œ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (ë¬¸ë²• ì˜¤ë¥˜, ìŠ¤íƒ€ì¼ ê°€ì´ë“œ ì¤€ìˆ˜)
      - name: ğŸ§¼ ESLint check
        run: bun run lint:check

      # Prettierë¡œ ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ (ì¼ê´€ëœ ì½”ë“œ ìŠ¤íƒ€ì¼)
      - name: ğŸ’… Prettier check
        run: bun run format:check

      # TypeScript íƒ€ì… ê²€ì‚¬ (íƒ€ì… ì•ˆì „ì„± í™•ë³´)
      - name: ğŸ§  Type check
        run: bun run types:check

      # Next.js ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ (ë°°í¬ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸)
      - name: ğŸ— Build app
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          NEXT_PUBLIC_GISCUS_REPO: ${{ vars.NEXT_PUBLIC_GISCUS_REPO }}
          NEXT_PUBLIC_GISCUS_REPO_ID: ${{ vars.NEXT_PUBLIC_GISCUS_REPO_ID }}
          NEXT_PUBLIC_GISCUS_CATEGORY_ID: ${{ vars.NEXT_PUBLIC_GISCUS_CATEGORY_ID }}
          NEXT_PUBLIC_GA_ID: ${{ vars.NEXT_PUBLIC_GA_ID }}
        run: bun run build

  # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‘ì—…
  # lint-build ì„±ê³µ í›„ ì‹¤í–‰ë˜ë©° í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ìƒì„±
  unit-test:
    runs-on: ubuntu-latest
    needs: lint-build    # lint-build ì‘ì—… ì™„ë£Œ í›„ ì‹¤í–‰

    steps:
      # ì €ì¥ì†Œ ì½”ë“œë¥¼ ì›Œí¬í”Œë¡œìš° í™˜ê²½ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
      - name: ğŸ› Checkout repository
        uses: actions/checkout@v6

      # Bun ëŸ°íƒ€ì„ ì„¤ì •
      - name: ğŸ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # ì˜ì¡´ì„± ìºì‹œ ë³µì› (ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•)
      - name: ğŸ’¾ Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      # í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ğŸ“¥ Install dependencies
        run: bun install

      # Vitestë¥¼ ì‚¬ìš©í•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ì»¤ë²„ë¦¬ì§€ ìƒì„±
      - name: ğŸ§ª Run unit tests with coverage
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          NEXT_PUBLIC_GISCUS_REPO: ${{ vars.NEXT_PUBLIC_GISCUS_REPO }}
          NEXT_PUBLIC_GISCUS_REPO_ID: ${{ vars.NEXT_PUBLIC_GISCUS_REPO_ID }}
          NEXT_PUBLIC_GISCUS_CATEGORY_ID: ${{ vars.NEXT_PUBLIC_GISCUS_CATEGORY_ID }}
          NEXT_PUBLIC_GA_ID: ${{ vars.NEXT_PUBLIC_GA_ID }}
        run: bun run test:unit:run --coverage

      # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ë¥¼ Codecovì— ì—…ë¡œë“œ
      - name: ğŸ“Š Upload unit test coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/lcov.info    # ì»¤ë²„ë¦¬ì§€ íŒŒì¼ ê²½ë¡œ
          flags: unit-tests             # Codecovì—ì„œ êµ¬ë¶„í•˜ê¸° ìœ„í•œ í”Œë˜ê·¸
          name: unit-test-coverage     # ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì´ë¦„
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false       # ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œì—ë„ CI ì¤‘ë‹¨í•˜ì§€ ì•ŠìŒ

      # ì»¤ë²„ë¦¬ì§€ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ë‹¤ë¥¸ ì‘ì—…ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
      - name: ğŸ“¦ Upload coverage artifact
        uses: actions/upload-artifact@v5
        with:
          name: unit-test-coverage
          path: coverage/


