# Dependabot PR ìë™ ë³‘í•© ì›Œí¬í”Œë¡œìš°
# Dependabotì´ ìƒì„±í•œ PRì„ íŠ¹ì • ì¡°ê±´ì— ë”°ë¼ ìë™ìœ¼ë¡œ ë³‘í•©í•©ë‹ˆë‹¤.
name: Auto-merge Dependabot PRs

# íŠ¸ë¦¬ê±° ì¡°ê±´: PRì´ ì—´ë¦¬ê±°ë‚˜ ì—…ë°ì´íŠ¸ë  ë•Œ ì‹¤í–‰
# pull_request_targetì„ ì‚¬ìš©í•˜ì—¬ forked repoì—ì„œë„ ì•ˆì „í•˜ê²Œ ì‹¤í–‰
on:
  pull_request_target:
    types: [opened, synchronize]

# ì›Œí¬í”Œë¡œìš°ì— í•„ìš”í•œ ê¶Œí•œ ì„¤ì •
permissions:
  contents: write        # ì½”ë“œ ë³‘í•©ì„ ìœ„í•œ ê¶Œí•œ
  pull-requests: write   # PR ì¡°ì‘ì„ ìœ„í•œ ê¶Œí•œ

jobs:
  dependabot:
    runs-on: ubuntu-latest
    # Dependabotì´ ìƒì„±í•œ PRì—ì„œë§Œ ì‹¤í–‰
    if: github.actor == 'dependabot[bot]'
    steps:
      # Dependabot PRì˜ ë©”íƒ€ë°ì´í„° ìˆ˜ì§‘ (ì—…ë°ì´íŠ¸ íƒ€ì…, ì˜ì¡´ì„± ì¢…ë¥˜ ë“±)
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
      
      # ë©”ì´ì € ì—…ë°ì´íŠ¸ ê°ì§€ ì‹œ ì‹¤íŒ¨ ì²˜ë¦¬
      # ì˜ˆ: 1.x.x â†’ 2.x.x (Breaking Changes ê°€ëŠ¥ì„±ìœ¼ë¡œ ì¸í•œ ìˆ˜ë™ ê²€í†  í•„ìˆ˜)
      - name: Block major updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        run: |
          echo "::error::Major version update detected for ${{ steps.metadata.outputs.dependency-names }}"
          echo "::error::Major updates require manual review due to potential breaking changes"
          echo "::error::Please review the changelog and test thoroughly before merging"
          exit 1

      # íŒ¨ì¹˜ ì—…ë°ì´íŠ¸ ìë™ ë³‘í•© (squash merge ì‚¬ìš©)
      # ì˜ˆ: 1.2.3 â†’ 1.2.4 (ë²„ê·¸ ìˆ˜ì •, ë³´ì•ˆ íŒ¨ì¹˜ ë“± - ì•ˆì „í•¨)
      - name: Auto-merge for patch updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
          
      # ê°œë°œ ì˜ì¡´ì„±ì˜ ë§ˆì´ë„ˆ ì—…ë°ì´íŠ¸ ìë™ ë³‘í•© (squash merge ì‚¬ìš©)
      # ì˜ˆ: ê°œë°œ ë„êµ¬ ì—…ë°ì´íŠ¸ (1.2.0 â†’ 1.3.0) - í”„ë¡œë•ì…˜ì— ì˜í–¥ ì—†ìŒ
      - name: Auto-merge for minor updates in dev dependencies
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-minor' &&
          steps.metadata.outputs.dependency-type == 'direct:development'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

# âš ï¸ ì£¼ì˜ì‚¬í•­:
# 1. ë©”ì´ì € ì—…ë°ì´íŠ¸(ì˜ˆ: 1.x.x â†’ 2.x.x)ëŠ” ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ë¡œ ì²˜ë¦¬ë˜ì–´ ìˆ˜ë™ ê²€í†  ê°•ì œ
# 2. í”„ë¡œë•ì…˜ ì˜ì¡´ì„±ì˜ ë§ˆì´ë„ˆ ì—…ë°ì´íŠ¸ë„ ìˆ˜ë™ ê²€í†  ê¶Œì¥
# 3. Branch protection rules ì„¤ì • ì‹œ CI í†µê³¼ í›„ì—ë§Œ ìë™ ë³‘í•©ë¨
# 4. --auto --squash í”Œë˜ê·¸ë¡œ squash merge ë°©ì‹ ì‚¬ìš©í•˜ì—¬ ì»¤ë°‹ íˆìŠ¤í† ë¦¬ ì •ë¦¬

# ğŸ’¡ ìë™ ë³‘í•© ì¡°ê±´:
# âœ… íŒ¨ì¹˜ ì—…ë°ì´íŠ¸ (x.x.1 â†’ x.x.2): ëª¨ë“  ì˜ì¡´ì„± (squash merge)
# âœ… ë§ˆì´ë„ˆ ì—…ë°ì´íŠ¸ (x.1.x â†’ x.2.x): ê°œë°œ ì˜ì¡´ì„±ë§Œ (squash merge)
# âŒ ë©”ì´ì € ì—…ë°ì´íŠ¸ (1.x.x â†’ 2.x.x): ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ë¡œ ê°•ì œ ìˆ˜ë™ ê²€í† 
# âŒ í”„ë¡œë•ì…˜ ì˜ì¡´ì„± ë§ˆì´ë„ˆ ì—…ë°ì´íŠ¸: ìˆ˜ë™ ê²€í† 
